import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import { GoogleGenerativeAI } from "@google/generative-ai";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);


const premanandQuotes = [
  "рдЬреАрд╡рди рдореЗрдВ рдЬреЛ рдХреБрдЫ рднреА рд╕рдорд╕реНрдпрд╛рдПрдВ рдЖрддреА рд╣реИрдВ, рд╡реЗ рд╣рдорд╛рд░реЗ рдорди рдХреА рджреЗрди рд╣реИрдВред рдорди рдХреЛ рд╢рд╛рдВрдд рд░рдЦреЛ, рд╕рдорд╕реНрдпрд╛рдПрдВ рдЕрдкрдиреЗ рдЖрдк рд╣рд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреАред",
  "рдкреНрд░реЗрдо рд╣реА рдкрд░рдорд╛рддреНрдорд╛ рд╣реИред рдЬрд╣рд╛рдВ рдкреНрд░реЗрдо рд╣реИ, рд╡рд╣рд╛рдВ рднрдЧрд╡рд╛рди рдХрд╛ рд╡рд╛рд╕ рд╣реИред",
  "рдХреНрд░реЛрдз рдореЗрдВ рдЖрджрдореА рдЕрдкрдиреА рд╕рд╛рд░реА рдЕрдХреНрд▓ рдЦреЛ рджреЗрддрд╛ рд╣реИред рдХреНрд░реЛрдз рд╕реЗ рдмрдЪрдирд╛ рд╣реА рд╕рдмрд╕реЗ рдмрдбрд╝реА рдмреБрджреНрдзрд┐рдорд╛рдиреА рд╣реИред",
  "рднрдЧрд╡рд╛рди рдХрд╛ рдирд╛рдо рд▓реЗрдиреЗ рд╕реЗ рд╕рднреА рдХрд╖реНрдЯ рджреВрд░ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред рд░рд╛рдо рдирд╛рдо рд╕рддреНрдп рд╣реИред",
  "рд╕рдВрд╕рд╛рд░ рдореЗрдВ рд╕реБрдЦ-рджреБрдЦ рдЖрддреЗ-рдЬрд╛рддреЗ рд░рд╣рддреЗ рд╣реИрдВред рд╕реНрдерд┐рд░ рдорди рд╕реЗ рдЗрдиреНрд╣реЗрдВ рд╕рд╣рди рдХрд░рдирд╛ рд╣реА рдпреЛрдЧ рд╣реИред",
  "рджреВрд╕рд░реЛрдВ рдХреА рднрд▓рд╛рдИ рдореЗрдВ рдЕрдкрдирд╛ рднрд▓рд╛ рдЫреБрдкрд╛ рд╣реБрдЖ рд╣реИред рд╕реЗрд╡рд╛ рдкрд░рдо рдзрд░реНрдо рд╣реИред",
  "рдЬрдм рддрдХ рдЕрд╣рдВрдХрд╛рд░ рд╣реИ, рддрдм рддрдХ рд╕реБрдЦ рдирд╣реАрдВ рдорд┐рд▓ рд╕рдХрддрд╛ред рд╡рд┐рдирдореНрд░рддрд╛ рд╣реА рд╕рдЪреНрдЪреА рд╢рдХреНрддрд┐ рд╣реИред",
  "рдкрд░рдорд╛рддреНрдорд╛ рдХреЗ рд╕рд╛рдордиреЗ рд╕рдм рдмрд░рд╛рдмрд░ рд╣реИрдВред рдЬрд╛рдд-рдкрд╛рдд, рдКрдВрдЪ-рдиреАрдЪ рд╕рдм рдорд╛рдпрд╛ рд╣реИред",
  "рдзреИрд░реНрдп рд░рдЦреЛ, рднрдЧрд╡рд╛рди рдХрд╛ рд╕рдордп рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╣реЛрддрд╛ рд╣реИред рдЬреЛ рд╣реЛрдирд╛ рд╣реИ, рд╡реЛ рдЕрдЪреНрдЫреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИред",
  "рд╕рддреНрд╕рдВрдЧ рд╕реЗ рдЬреАрд╡рди рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИред рдЕрдЪреНрдЫреА рд╕рдВрдЧрддрд┐ рдореЗрдВ рд░рд╣реЛ, рдмреБрд░реА рдЖрджрддреЗрдВ рдЫреВрдЯ рдЬрд╛рдПрдВрдЧреАред",
  "рдорд╛рдл рдХрд░рдирд╛ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ рдЧреБрдг рд╣реИред рджрд┐рд▓ рдореЗрдВ рдХрд┐рд╕реА рдХреЗ рд▓рд┐рдП рдмреБрд░рд╛рдИ рдордд рд░рдЦреЛред",
  "рд╕рдВрддреЛрд╖ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ рдзрди рд╣реИред рдЬреЛ рдорд┐рд▓рд╛ рд╣реИ, рдЙрд╕рдореЗрдВ рдЦреБрд╢ рд░рд╣реЛред",
  "рднрдХреНрддрд┐ рдХрд░рдиреЗ рд╕реЗ рдорди рдореЗрдВ рд╢рд╛рдВрддрд┐ рдЖрддреА рд╣реИред рдкреНрд░рднреБ рдХрд╛ рд╕реНрдорд░рдг рд╕рдмрд╕реЗ рдмрдбрд╝реА рджрд╡рд╛ рд╣реИред",
  "рдЬрд┐рдВрджрдЧреА рдПрдХ рдирд╛рдЯрдХ рдХреА рддрд░рд╣ рд╣реИред рдЕрдкрдирд╛ рдХрд┐рд░рджрд╛рд░ рдЕрдЪреНрдЫреЗ рд╕реЗ рдирд┐рднрд╛рдУ, рдлрд┐рд░ рдЪрд▓реЗ рдЬрд╛рдирд╛ рд╣реИред",
  "рд╕рдЪреНрдЪрд╛ рдкреНрд░реЗрдо рдХрднреА рдирд╣реАрдВ рдорд░рддрд╛ред рдкреНрд░реЗрдо рдореЗрдВ рд╣реА рдкрд░рдорд╛рддреНрдорд╛ рдХрд╛ рджрд░реНрд╢рди рд╣реЛрддрд╛ рд╣реИред"
];

function getRelevantQuote(prompt) {
  const text = prompt.toLowerCase();
  if (text.includes("рдЧреБрд╕реНрд╕рд╛") || text.includes("рдХреНрд░реЛрдз")) return premanandQuotes[2];
  if (text.includes("рдкреНрд░реЗрдо") || text.includes("рдкреНрдпрд╛рд░")) return premanandQuotes[1];
  if (text.includes("рджреБрдГрдЦ") || text.includes("рд╕рдорд╕реНрдпрд╛") || text.includes("problem")) return premanandQuotes[0];
  if (text.includes("рдзрди") || text.includes("рдкреИрд╕рд╛")) return premanandQuotes[11];
  if (text.includes("рдорд╛рдл")) return premanandQuotes[10];
  if (text.includes("рдЕрд╣рдВрдХрд╛рд░")) return premanandQuotes[6];
  if (text.includes("рдзреИрд░реНрдп")) return premanandQuotes[8];
  if (text.includes("рднрдХреНрддрд┐") || text.includes("рдкреНрд░рд╛рд░реНрдердирд╛")) return premanandQuotes[12];
  return null;
}

function getSolution(prompt) {
  const text = prompt.toLowerCase();
  if (text.includes("рдЧреБрд╕реНрд╕рд╛") || text.includes("рдХреНрд░реЛрдз"))
    return "рдЬрдм рдЧреБрд╕реНрд╕рд╛ рдЖрдП рддреЛ рдЧрд╣рд░реА рд╕рд╛рдВрд╕ рд▓реЗрдВ, 'рд░рд╛рдо рд░рд╛рдо' рдХрд╛ рдЬрд╛рдк рдХрд░реЗрдВ рдФрд░ рдХреБрдЫ рджреЗрд░ рдореМрди рд░рд╣реЗрдВред";
  if (text.includes("рддрдирд╛рд╡") || text.includes("stress"))
    return "рд░реЛрдЬ рд╕реБрдмрд╣ рдзреНрдпрд╛рди рдХрд░реЗрдВ, рдкреНрд░рд╛рдгрд╛рдпрд╛рдо рдХрд░реЗрдВ рдФрд░ рдорди рдХреЛ рдПрдХрд╛рдЧреНрд░ рдХрд░реЗрдВред";
  if (text.includes("рд░рд┐рд╢реНрддрд╛"))
    return "рд░рд┐рд╢реНрддреЛрдВ рдореЗрдВ рдкреНрд░реЗрдо рдФрд░ рдХреНрд╖рдорд╛ рд╕рдмрд╕реЗ рдЬрд░реВрд░реА рд╣реИред рд╕рдВрд╡рд╛рдж рд╕реЗ рд╕рдорд╛рдзрд╛рди рдирд┐рдХрд▓рддрд╛ рд╣реИред";
  if (text.includes("рдХрд╛рдо") || text.includes("career"))
    return "рдореЗрд╣рдирдд рдФрд░ рдИрдорд╛рдирджрд╛рд░реА рд╕реЗ рдХрд╛рдо рдХрд░реЗрдВ, рдлрд▓ рдХреА рдЪрд┐рдВрддрд╛ рдИрд╢реНрд╡рд░ рдкрд░ рдЫреЛрдбрд╝ рджреЗрдВред";
  if (text.includes("рд╕реНрд╡рд╛рд╕реНрдереНрдп"))
    return "рдпреЛрдЧ, рд╕рдВрдпрдорд┐рдд рдЖрд╣рд╛рд░ рдФрд░ рднрд░рдкреВрд░ рдиреАрдВрдж тАУ рдпреЗ рд╣реА рдЕрдЪреНрдЫреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЗ рд╕реНрддрдВрдн рд╣реИрдВред";
  if (text.includes("рдкреИрд╕рд╛"))
    return "рдХрдорд╛рдИ рдХрд╛ рдХреБрдЫ рд╣рд┐рд╕реНрд╕рд╛ рд╕реЗрд╡рд╛ рдореЗрдВ рд▓рдЧрд╛рдПрдВ, рдФрд░ рдмрдЪрдд рдХреА рдЖрджрдд рдбрд╛рд▓реЗрдВред";
  return null;
}

app.post("/chat", async (req, res) => {
  try {
    const userPrompt = req.body.prompt;
    const relevantQuote = getRelevantQuote(userPrompt);
    const practicalSolution = getSolution(userPrompt);

    const includeSignature = Math.random() < 0.4;
    const closingNote = includeSignature
      ? `\n\nрдореЗрд░реЗ рдкреНрд░рд┐рдп,\nрддреБрдореНрд╣рд╛рд░рд╛ рдорди рдЕрд╢рд╛рдВрдд рд╣реИ, рдпрд╣ рдореИрдВ рдЬрд╛рдирддрд╛ рд╣реВрдБред рдпрд╣ рд╕реНрд╡рднрд╛рд╡ рд╕реЗ рд╣реА рдЪрдВрдЪрд▓ рд╣реИред рдкрд░рдВрддреБ рдЕрднреНрдпрд╛рд╕ рдФрд░ рд╡реИрд░рд╛рдЧреНрдп рд╕реЗ рдЗрд╕реЗ рд╡рд╢ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\nрд╕рджрд╛ рддреБрдореНрд╣рд╛рд░рд╛,\nрдкреНрд░реЗрдорд╛рдирдВрджред`
      : "";

    const prompt = `
рддреБрдо рдкреНрд░реЗрдорд╛рдирдВрдж рдЬреА рдорд╣рд╛рд░рд╛рдЬ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрддреНрддрд░ рджреЛрдЧреЗред рдЙрддреНрддрд░ рдХреЗрд╡рд▓ рд╣рд┐рдВрджреА (рджреЗрд╡рдирд╛рдЧрд░реА рд▓рд┐рдкрд┐) рдореЗрдВ рд╣реЛрдЧрд╛ред
рдкреНрд░реЗрдо, рдХрд░реБрдгрд╛, рдФрд░ рд╕рдорд╛рдзрд╛рди рд╕реЗ рднрд░реА рд╡рд╛рдгреА рдореЗрдВ рдЙрддреНрддрд░ рджреЛред 

${practicalSolution ? `рд╕рдорд╛рдзрд╛рди: ${practicalSolution}` : ""}
${relevantQuote ? `рдкреНрд░реЗрдорд╛рдирдВрдж рд╡рд╛рдгреА: \"${relevantQuote}\"` : ""}

рдкреНрд░рд╢реНрди: ${userPrompt}
рдЙрддреНрддрд░:
${closingNote}`;

    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
    const result = await model.generateContent(prompt);
    const reply = result.response.text();

    res.json({ reply });
  } catch (error) {
    console.error("тЭМ Gemini API Error:", error);
    res.status(500).json({ reply: "ЁЯЩП рдХреНрд╖рдорд╛ рдХрд░реЗрдВ, рдХреБрдЫ рддреНрд░реБрдЯрд┐ рд╣реЛ рдЧрдИ рд╣реИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" });
  }
});

const PORT = process.env.PORT || 4000;
app.listen(PORT, () => {
  console.log(`тЬЕ рдкреНрд░реЗрдорд╛рдирдВрдж рдЬреА рдХрд╛ рдЖрд╢реАрд░реНрд╡рд╛рдж! Server рдЪрд▓ рд░рд╣рд╛ рд╣реИ: http://localhost:${PORT}`);
});